---
title: "Plot data from I18 - 2"
output: 
  pdf_document: 
    fig_height: 7
---

Uses a data file set up by "plot_I18_files_1.Rmd"
```{r}
rm(list = ls())
setwd("~/WORKSHOP/QAANAAQ/")
library(stats)
#
# Define the window size for the moving average (low-pass filter)
window_size <- 444
#
df <- readRDS("OUTPUT/calving_2022123.rds")
df$POSIX <- as.POSIXct(df$POSIX, tz="UTC")
cnams <- colnames(df)
```


# define a high-pass filter
```{r}
gohipassfilter <- function(data,window_size=5)
{
# Create a low-pass filter using a moving average
low_pass_filter <- filter(data, rep(1/window_size, window_size), sides=2)

# Subtract the low-pass filter from the original time series to get the high-pass filter
high_pass_filter <- data - low_pass_filter

return(high_pass_filter)  

}
```


# plot in panel
```{r}
#
start_time <- as.POSIXct("2022-05-03 14:10:00 UTC")
end_time <- as.POSIXct("2022-05-03 14:13:00 UTC")
idx <- which(df$POSIX >= start_time & df$POSIX < end_time)
dd <- df[idx,]
dd <- na.omit(dd)
dd[,2:9] <- scale(dd[,2:9])
for (icol in 2:(ncol(dd)-1)){dd[,icol] <- gohipassfilter(dd[,icol],window_size)}
dd <- na.omit(dd)
for (icol in 2:(ncol(dd)-1))
{
  plot(dd[,c(10,icol)],main=cnams[icol],type="l")

  
}
plot(dd[,c(10,2)],main=cnams[icol],type="l",col=1,ylim=c(-3,3))
lines(dd[,c(10,3)],main=cnams[icol],type="l",col=2)
lines(dd[,c(10,4)],main=cnams[icol],type="l",col=3)
lines(dd[,c(10,5)],main=cnams[icol],type="l",col=4)
lines(dd[,c(10,6)],main=cnams[icol],type="l",col=5)
lines(dd[,c(10,7)],main=cnams[icol],type="l",col=6)
lines(dd[,c(10,8)],main=cnams[icol],type="l",col=7)
lines(dd[,c(10,9)],main=cnams[icol],type="l",col=8)

```

# define an offset-finder function
```{r}
offset_finder <- function(y1,y2)
{
# Calculate cross-correlation
cross_corr <- ccf(y1, y2)

# Find lag with maximum correlation
max_corr_index <- which.max(cross_corr$acf)

# Get lag corresponding to maximum correlation
optimal_offset <- cross_corr$lag[max_corr_index]
return(optimal_offset/20)
}
```




# Find time offsets between instruments given a data-window
```{r}

  series1 <- dd[,2]
  series2 <- dd[,3]
  series3 <- dd[,4]
  series4 <- dd[,5]
  series5 <- dd[,6]
  series6 <- dd[,7]
  series7 <- dd[,8]
  series8 <- dd[,9]
 
  d12 <- offset_finder(series2,series1)
  d13 <- offset_finder(series2,series3)
  d14 <- offset_finder(series2,series4)
  d15 <- offset_finder(series2,series5)
  d16 <- offset_finder(series2,series6)
  d17 <- offset_finder(series2,series7)
  d18 <- offset_finder(series2,series8)
```



 